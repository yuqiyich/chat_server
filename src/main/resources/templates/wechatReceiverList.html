<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<title>微信公众号消息接收者列表</title>
<link rel="stylesheet" href="/js/layui2.5.6/css/layui.css">
<style>
	body{padding: 20px; /*overflow-y: scroll;*/}
</style>
</head>

<body>
	<table id="test" lay-filter="test"></table>

	<script type="text/html" id="toolbarDemo">
		<div class="layui-btn-container">
		  <button id="btn_showQrcodeView" class="layui-btn layui-btn-sm" lay-event="showQrcodeView">添加绑定</button>
		  <button id="btn_showQrcodeView" class="layui-btn layui-btn-sm" lay-event="testSendMsg">测试全量通知</button>
		</div>
	</script>
	<script src="/js/layui2.5.6/layui.js" charset="utf-8"></script>
	<script type="text/html" id="tpl_user_status">
		{{#  if(d.userStatus == '1'){ }}
		启用
		{{#  } else { }}
		禁用
		{{#  } }}
	</script>
	<script>
		layui.use('table', function(){
		var table = layui.table;
		
		table.render({
			elem: '#test'
			// ,height:400
			// ,height: 'full - 20'
			//,width: 600
			,title: '微信公众号消息通知接收者表'
			,url: '/wechat/receiver/list'
			// ,text: '无数据'
			//,size: 'lg'
			,page: {curr: 1}
			// ,autoSort: false
			// ,loading: false
			// ,totalRow: true
			,limit: 10
			,limits: [10, 30, 50, 100]
			,toolbar: '#toolbarDemo'
			// ,toolbar: true
			// 右上角工具条
			,defaultToolbar: ['filter', 'exports', 'print'
				// , {
				// title: '帮助'
				// ,layEvent: 'LAYTABLE_TIPS'
				// ,icon: 'layui-icon-tips'
				// }
				, {
				title: '刷新'
				,layEvent: 'reloadData'
				,icon: 'layui-icon-refresh'
				}
				// , {
				// title: '添加'
				// ,layEvent: 'showQrcodeView'
				// ,icon: 'layui-icon-add-1'
				// }
			]
			,cols: [
				[
				{field:'id', title:'ID', fixed:'left', width:60, unresize:true, sort:true, align: 'center'}
				,{field:'openid', title:'openid', sort:false, align: 'center'}
				,{field:'nickname', title:'微信昵称', sort:false, align: 'center'}
				,{field:'remark', title:'备注名', sort:false, align: 'center'}
				,{field:'userStatus', templet: '#tpl_user_status', title:'状态', width:60, unresize:true, sort:false, align: 'center'}
				]
			]
			// ,response: {
			// 	statusName: 'errorCode'
			// 	,statusCode: 0
			// }
			,parseData: function(res){
				return {
					"code": res.errorCode
					,"msg": res.errorMsg
					,"count": res.data.totalSize
					,"data": res.data.list
				};
			}
		});

		//工具栏事件
		table.on('toolbar(test)', function(obj){
			var checkStatus = table.checkStatus(obj.config.id);
			switch(obj.event){
				case 'showQrcodeView':
					layer.open({
						type: 1, 
						// content: ["<div style='text-align: center;background-color: white;width:100;'><p style='margin-top: 20;color: black;'>扫码绑定微信账号（绑定后还需关注公众号才能接收消息）</p><img style='width:30%; height: 30%;' src='/img/wechat_bind.png' /></div>" //这里content是一个普通的String
						// 	, '#btn_showQrcodeView']
						content: "<div style='text-align: center;'><p>扫码绑定微信账号<br>（还需关注公众号才能接收消息）</p><img style='width:120px; height: 120px;' src='/img/wechat_bind.png' /></div>"
					});
					// layer.alert('扫码绑定新的微信接收者', {icon: '/img/wechat_bind.png'});
				break;
				case 'testSendMsg':
					$.ajax({
						type: "POST",
						url: "/wechat/template/send",
						// data: {username:$("#username").val(), content:$("#content").val()},//请求的参数
						dataType: "json",//以json格式返回的数据，不是json就把此行去掉
						success: function(dataResult){
							if (null != dataResult) {
								if (dataResult.errorCode == 0) {
									console.log("--->result dataResult.size:" + dataResult.data.size);
									layer.msg('发送成功，size:' + dataResult.data.size);
								} else {
									console.log("--->result code:" + dataResult.errorCode + ", msg:" + dataResult.errorMsg);
									layer.msg('发送失败:' + dataResult.errorMsg);
								}
							}
						}
					});
				break;
				case 'update':
					layer.msg('编辑');
				break;
				case 'delete':
					layer.msg('删除');
				break;
				case 'getCheckData':
					var data = checkStatus.data;
					layer.alert(JSON.stringify(data));
				break;
				case 'getCheckLength':
					var data = checkStatus.data;
					layer.msg('选中了：'+ data.length + ' 个');
				break;
				case 'isAll':
					layer.msg(checkStatus.isAll ? '全选': '未全选')
				break;
				// case 'LAYTABLE_TIPS':
				// 	layer.alert('Table for layui-v'+ layui.v);
				// break;
				case 'reloadData':
					table.reload('test', {
					page: {curr: 1}
					//,height: 300
					//,url: 'x'
					}, 'data');
				break;
			};
		});

		// table.on('row(test)', function(obj){
		// 	console.log(obj);
		// 	//layer.closeAll('tips');
		// });

		// //监听表格行点击
		// table.on('tr', function(obj){
		// 	console.log(obj)
		// });

		// //监听表格复选框选择
		// table.on('checkbox(test)', function(obj){
		// 	console.log(obj)
		// });

		// //监听表格单选框选择
		// table.on('radio(test)', function(obj){
		// 	console.log(obj)
		// });
		
		// //监听表格单选框选择
		// table.on('rowDouble(test)', function(obj){
		// 	console.log(obj);
		// });
		
		// //监听单元格编辑
		// table.on('edit(test)', function(obj){
		// 	var value = obj.value //得到修改后的值
		// 	,data = obj.data //得到所在行所有键值
		// 	,field = obj.field; //得到字段
			
		// 	console.log(obj)
		// });
		
		// //监听行工具事件
		// table.on('tool(test)', function(obj){
		// 	var data = obj.data;
		// 	//console.log(obj)
		// 	if(obj.event === 'del'){
		// 	layer.confirm('真的删除行么', function(index){
		// 		obj.del();
		// 		layer.close(index);
		// 	});
		// 	} else if(obj.event === 'edit'){
		// 	layer.prompt({
		// 		formType: 2
		// 		,value: data.email
		// 	}, function(value, index){
		// 		obj.update({
		// 		email: value
		// 		});
		// 		layer.close(index);
		// 	});
		// 	}
		// });
		
		//监听排序
		table.on('sort(test)', function(obj){
			// 本地该页数据排序
			table.reload('test', {
			initSort: obj
				//,page: {curr: 1} //重新从第一页开始
			// ,where: { //重新请求服务端
			// 	key: obj.field //排序字段
			// 	,order: obj.type //排序方式
			// }
			});
		});
		
		var $ = layui.jquery, active = {
			parseTable: function(){
			table.init('parse-table-demo', {
				limit: 3
			});
			}
			,add: function(){
			table.addRow('test')
			}
		};
		$('i').on('click', function(){
			var type = $(this).data('type');
			active[type] ? active[type].call(this) : '';
		});
		$('.layui-btn').on('click', function(){
			var type = $(this).data('type');
			active[type] ? active[type].call(this) : '';
		});
		});
	</script>
</body>
</html>